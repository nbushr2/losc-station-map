<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Louisiana Map Dashboard</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --purple:#3b1b6b;
      --purple2:#5c2aa6;
      --card:#ffffff;
      --bg:#f6f6fb;
      --text:#1c1c1c;
      --muted:#6b6b6b;
      --danger-bg:#fde7ea;
      --danger:#b42318;
      --border:#e6e6ef;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      display:grid;
      grid-template-columns: 380px 1fr;
      height:100vh;
    }
    .panel{
      overflow:auto;
      padding:18px 16px;
      border-right:1px solid var(--border);
      background:linear-gradient(180deg, #ffffff, #fbfbff);
    }
    .map{
      position:relative;
      height:100%;
    }
    #map{
      height:100%;
      width:100%;
    }
    h1{
      margin:0 0 12px;
      font-size:34px;
      color:var(--purple);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      margin:12px 0;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }
    .sectionTitle{
      font-size:22px;
      margin:0 0 10px;
      color:var(--purple);
      display:flex;
      align-items:center;
      gap:10px;
    }
    label{
      display:block;
      font-size:14px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    input[type="date"], select{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      outline:none;
      font-size:15px;
      background:#fff;
    }
    input[type="date"]:focus, select:focus{
      border-color:#c3b2ff;
      box-shadow:0 0 0 3px rgba(123,92,255,.14);
    }
    .btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:14px 14px;
      font-size:18px;
      font-weight:650;
      background: linear-gradient(90deg, var(--purple), var(--purple2));
      color:#fff;
      cursor:pointer;
      margin-top:12px;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .checks{
      display:grid;
      gap:10px;
      margin-top:8px;
    }
    .checkItem{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:16px;
    }
    .checkItem input{
      width:18px;
      height:18px;
      accent-color: var(--purple);
    }
    .hr{
      height:1px;
      background:var(--border);
      margin:14px 0;
    }
    .alert{
      display:none;
      background:var(--danger-bg);
      color:var(--danger);
      border:1px solid #f4b4bd;
      padding:10px 12px;
      border-radius:12px;
      margin-top:12px;
      font-weight:600;
    }
    pre#log{
      margin:10px 0 0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1020;
      color:#d7def7;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      max-height:240px;
      overflow:auto;
    }
    .hint{
      font-size:13px;
      color:var(--muted);
      margin-top:8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="panel">
      <h1>üóìÔ∏è Select Date Range</h1>

      <div class="card">
        <div class="row">
          <div>
            <label for="startDate">Start Date</label>
            <input id="startDate" type="date" />
          </div>
          <div>
            <label for="endDate">End Date</label>
            <input id="endDate" type="date" />
          </div>
        </div>

        <label for="quickSelect">Quick Select</label>
        <select id="quickSelect">
          <option value="">Quick Select‚Ä¶</option>
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="last7">Last 7 days</option>
          <option value="last14">Last 14 days</option>
          <option value="thisMonth">This month</option>
        </select>

        <button class="btn" id="btnFetch">üìä Fetch Data</button>

        <div class="alert" id="uiError">‚ö†Ô∏è</div>
        <div class="hint">
          Note: this template doesn‚Äôt assume any API endpoint. It just validates dates and logs what it would request.
        </div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h2 class="sectionTitle">üó∫Ô∏è Map Layers</h2>
        <div class="checks">
          <label class="checkItem"><input id="chkState" type="checkbox" checked /> State Boundary</label>
          <label class="checkItem"><input id="chkClimate" type="checkbox" checked /> Climate Divisions</label>
          <label class="checkItem"><input id="chkParish" type="checkbox" checked /> Parish Boundaries</label>
          <label class="checkItem"><input id="chkStations" type="checkbox" checked /> Weather Stations</label>
        </div>
      </div>

      <div class="card">
        <h2 class="sectionTitle">üîç Diagnostic Log</h2>
        <pre id="log"></pre>
      </div>
    </aside>

    <main class="map">
      <div id="map"></div>
    </main>
  </div>

<script>
/* =========================================================
   Utilities (prevents your "div.slice is not a function" crash)
   ========================================================= */
function safeSlice(v, start, end) {
  return String(v ?? "").slice(start, end);
}
function $(id){ return document.getElementById(id); }

function logLine(msg){
  const t = new Date();
  const stamp = t.toLocaleTimeString();
  $("log").textContent += `[${stamp}] ${msg}\n`;
  $("log").scrollTop = $("log").scrollHeight;
}
function showError(msg){
  const el = $("uiError");
  el.style.display = "block";
  el.textContent = `‚ö†Ô∏è ${msg}`;
  logLine(`‚ùå ${msg}`);
}
function clearError(){
  $("uiError").style.display = "none";
  $("uiError").textContent = "";
}

/* =========================================================
   Default dates (match your screenshot example range)
   ========================================================= */
(function initDates(){
  // Default: 2026-02-18 to 2026-02-24 (change as you like)
  $("startDate").value = "2026-02-18";
  $("endDate").value   = "2026-02-24";
})();

/* =========================================================
   Map init
   ========================================================= */
const map = L.map("map", { zoomControl: true }).setView([30.9843, -91.9623], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

logLine("‚úÖ Map initialized");
logLine("‚úÖ Base map tiles loaded");

/* =========================================================
   Panes (so boundaries always draw above tiles)
   ========================================================= */
map.createPane("boundariesPane");
map.getPane("boundariesPane").style.zIndex = 450;

map.createPane("stationsPane");
map.getPane("stationsPane").style.zIndex = 500;

/* =========================================================
   Layer storage
   ========================================================= */
const layers = {
  state: null,
  climate: null,
  parishes: null,
  stations: null,
};

/* =========================================================
   GeoJSON loader with strict validation
   ========================================================= */
async function fetchGeoJSON(url){
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Failed to load ${url} (HTTP ${resp.status})`);
  const data = await resp.json();
  if (data?.type !== "FeatureCollection") {
    throw new Error(`Invalid GeoJSON (not FeatureCollection): ${url}`);
  }
  return data;
}

/* =========================================================
   Boundary layers (FIX: use ONLY the new parishes file)
   ========================================================= */
async function initBoundaryLayers(){
  logLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  logLine("Starting layer loads...");
  logLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");

  // State
  try{
    const gj = await fetchGeoJSON("./data/louisiana_state_boundary.geojson");
    layers.state = L.geoJSON(gj, {
      pane: "boundariesPane",
      style: { color:"#461D7C", weight:3, opacity:1, fillOpacity:0, dashArray:"10,5" }
    });
    logLine("‚úÖ State boundary loaded");
  }catch(e){ showError(e.message); }

  // Climate divisions
  try{
    const gj = await fetchGeoJSON("./data/louisiana_climate_divisions.geojson");
    layers.climate = L.geoJSON(gj, {
      pane: "boundariesPane",
      style: { color:"#2b2b2b", weight:2, opacity:1, fillOpacity:0.15 }
    });
    logLine("‚úÖ Climate divisions loaded");
  }catch(e){ showError(e.message); }

  // Parishes (NEW ONLY)
  try{
    const gj = await fetchGeoJSON("./data/louisiana_parishes_new.geojson");
    layers.parishes = L.geoJSON(gj, {
      pane: "boundariesPane",
      style: { color:"#666", weight:1.5, opacity:1, fillOpacity:0 }
    });
    logLine("‚úÖ Parish boundaries (new) loaded");
  }catch(e){ showError(e.message); }

  // Add initially checked ones
  if ($("chkState").checked && layers.state) layers.state.addTo(map);
  if ($("chkClimate").checked && layers.climate) layers.climate.addTo(map);
  if ($("chkParish").checked && layers.parishes) layers.parishes.addTo(map);

  logLine("‚úÖ Boundary layers added (based on checkboxes)");
}

/* =========================================================
   Example stations layer (optional)
   - Replace URL with your stations GeoJSON when you have it.
   ========================================================= */
async function initStationsLayer(){
  // If you don't have a stations file, this keeps UI stable without crashing.
  // Replace with your real file path when ready:
  const stationsUrl = "./data/louisiana_weather_stations.geojson";

  try{
    const gj = await fetchGeoJSON(stationsUrl);
    layers.stations = L.geoJSON(gj, {
      pane: "stationsPane",
      pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius:5, weight:1, fillOpacity:0.7 })
    });
    logLine("‚úÖ Weather stations loaded");

    if ($("chkStations").checked) layers.stations.addTo(map);
  }catch(e){
    logLine(`‚ÑπÔ∏è Weather stations not loaded (${safeSlice(e.message, 0, 160)}). If you don't have the file yet, ignore this.`);
  }
}

/* =========================================================
   Checkbox toggles
   ========================================================= */
function toggleLayer(chkId, key){
  const chk = $(chkId);
  const lyr = layers[key];
  if (!chk) return;

  if (!lyr){
    // Not loaded (yet) ‚Äî avoid crashes
    logLine(`‚ö†Ô∏è Layer not ready: ${key}`);
    return;
  }

  if (chk.checked) lyr.addTo(map);
  else map.removeLayer(lyr);
}

$("chkState").addEventListener("change",  () => toggleLayer("chkState", "state"));
$("chkClimate").addEventListener("change",() => toggleLayer("chkClimate", "climate"));
$("chkParish").addEventListener("change", () => toggleLayer("chkParish", "parishes"));
$("chkStations").addEventListener("change",() => toggleLayer("chkStations", "stations"));

/* =========================================================
   Quick select (FIX: never call .slice on an element)
   ========================================================= */
function setDateRangeISO(startISO, endISO){
  $("startDate").value = startISO;
  $("endDate").value = endISO;
}

$("quickSelect").addEventListener("change", () => {
  clearError();

  const choice = $("quickSelect").value; // ‚úÖ value, not the element
  const now = new Date();

  const toISO = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  };

  let start, end;

  if (choice === "today"){
    start = new Date(now);
    end = new Date(now);
  } else if (choice === "yesterday"){
    start = new Date(now); start.setDate(start.getDate()-1);
    end = new Date(start);
  } else if (choice === "last7"){
    end = new Date(now);
    start = new Date(now); start.setDate(start.getDate()-6);
  } else if (choice === "last14"){
    end = new Date(now);
    start = new Date(now); start.setDate(start.getDate()-13);
  } else if (choice === "thisMonth"){
    end = new Date(now);
    start = new Date(now.getFullYear(), now.getMonth(), 1);
  } else {
    return;
  }

  setDateRangeISO(toISO(start), toISO(end));
  logLine(`üóìÔ∏è Quick select applied: ${choice}`);
});

/* =========================================================
   Fetch Data button (you can wire your real API here)
   ========================================================= */
$("btnFetch").addEventListener("click", async () => {
  clearError();

  const startISO = $("startDate").value;
  const endISO   = $("endDate").value;

  if (!startISO || !endISO){
    showError("Please select both start and end dates.");
    return;
  }
  if (startISO > endISO){
    showError("Start date cannot be after end date.");
    return;
  }

  // Example request payload (replace with your real endpoint)
  logLine("üì¶ Preparing data request...");
  logLine(`Start: ${startISO} | End: ${endISO}`);

  // If you had an API endpoint, you'd do something like:
  // const resp = await fetch(`/api/data?start=${startISO}&end=${endISO}`);
  // const data = await resp.json();
  // ... then draw on map

  logLine("‚úÖ (Template) Data fetch simulated. Wire your API call here.");
});

/* =========================================================
   Boot
   ========================================================= */
(async function boot(){
  try{
    await initBoundaryLayers();
    await initStationsLayer();
  }catch(e){
    showError(e.message);
  }
})();
</script>
</body>
</html>
